<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping in Progress - YouTube Channel Scraper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="card results-card">
            <div class="logo">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                    <path
                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                </svg>
            </div>
            <h1>Scraping Channel</h1>

            <div id="status-container">
                <div class="status-message" id="message">Initializing...</div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0%</div>
                </div>

                <div class="current-video" id="current-video"></div>
            </div>

            <div id="error-container" class="error-message" style="display: none;"></div>

            <div id="success-container" style="display: none;">
                <div class="success-message">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    <span id="success-text">Scraping complete!</span>
                </div>

                <a href="{{ url_for('download', job_id=job_id) }}" class="download-btn" id="download-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    <span>Download CSV</span>
                </a>
            </div>

            <a href="{{ url_for('index') }}" class="back-link">‚Üê Scrape Another Channel</a>
        </div>
    </div>

    <script>
        const jobId = "{{ job_id }}";
        const statusUrl = "{{ url_for('status', job_id=job_id) }}";

        const messageEl = document.getElementById('message');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const currentVideoEl = document.getElementById('current-video');
        const statusContainer = document.getElementById('status-container');
        const errorContainer = document.getElementById('error-container');
        const successContainer = document.getElementById('success-container');
        const successText = document.getElementById('success-text');

        async function checkStatus() {
            try {
                const response = await fetch(statusUrl);
                const data = await response.json();

                // Update message
                messageEl.textContent = data.message;

                // Update progress
                if (data.total > 0) {
                    const percent = Math.round((data.progress / data.total) * 100);
                    progressFill.style.width = percent + '%';
                    progressText.textContent = `${data.progress} / ${data.total} videos`;
                }

                // Update current video
                if (data.current) {
                    currentVideoEl.textContent = `Processing: ${data.current}`;
                }

                // Handle completion
                if (data.status === 'completed') {
                    statusContainer.style.display = 'none';
                    successContainer.style.display = 'block';
                    successText.textContent = data.message;
                    return; // Stop polling
                }

                // Handle error
                if (data.status === 'error') {
                    statusContainer.style.display = 'none';
                    errorContainer.style.display = 'block';
                    errorContainer.textContent = data.message;
                    return; // Stop polling
                }

                // Continue polling
                setTimeout(checkStatus, 1000);

            } catch (error) {
                console.error('Status check failed:', error);
                setTimeout(checkStatus, 2000);
            }
        }

        // Start polling
        checkStatus();
    </script>
</body>

</html>